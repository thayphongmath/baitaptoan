<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªá th·ªëng ƒë·ªÅ thi</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #adminPanel, #examPanel { padding: 10px; }
    #examPanel { display: none; height: 100vh; flex-direction: column; }
    #pdf-container { flex: 9; }
    #answer-bar {
      flex: 1;
      border-top: 2px solid #ccc;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 4px;
    }
    #question { text-align: center; font-weight: bold; margin-bottom: 4px; }
    .options-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; width: 100%; }
    .center-options { display: flex; justify-content: center; align-items: center; gap: 8px; flex-grow: 1; }
    .square { width: 50px; height: 50px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; user-select: none; }
    .square.selected { background: #4caf50; color: white; }
    .short-answer input { width: 50px; height: 50px; font-size: 18px; text-align: center; }
    button { padding: 6px 10px; font-size: 14px; border: none; border-radius: 5px; background: #2196f3; color: white; cursor: pointer; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    #shareLink { margin-top: 10px; font-weight: bold; color: green; }
  </style>
</head>
<body>

<!-- ========== ADMIN GIAO DI·ªÜN ========== -->
<div id="adminPanel">
  <h2>T·∫°o ƒë·ªÅ thi (Admin)</h2>
  <label>Link PDF: <input id="pdfLink" size="60" placeholder="D√°n link Google Drive PDF..."></label><br><br>
  <label>S·ªë c√¢u Tr·∫Øc nghi·ªám: <input id="numMCQ" type="number" value="1" min="0"></label><br>
  <label>S·ªë c√¢u ƒê√∫ng/Sai: <input id="numTF" type="number" value="1" min="0"></label><br>
  <label>S·ªë c√¢u Ng·∫Øn: <input id="numShort" type="number" value="1" min="0"></label><br><br>
  <button onclick="createExam()">T·∫°o ƒë·ªÅ</button>
  <div id="shareLink"></div>
</div>

<!-- ========== STUDENT GIAO DI·ªÜN ========== -->
<div id="examPanel">
  <div id="pdf-container">
    <iframe id="pdfFrame" width="100%" height="100%"></iframe>
  </div>
  <div id="answer-bar">
    <div id="question"></div>
    <div class="options-row">
      <button id="backBtn">‚óÄ Quay l·∫°i</button>
      <div class="center-options" id="options"></div>
      <button id="nextBtn">Ti·∫øp ‚ñ∂</button>
    </div>
  </div>
</div>

<script>
  let questions = [];
  let answers = {};
  let current = 0;

  // ========== ADMIN ==========
  function createExam() {
    const pdfLink = document.getElementById("pdfLink").value.trim();
    const numMCQ = parseInt(document.getElementById("numMCQ").value);
    const numTF = parseInt(document.getElementById("numTF").value);
    const numShort = parseInt(document.getElementById("numShort").value);

    questions = [];
    let counter = 1;

    for (let i=0;i<numMCQ;i++) {
      questions.push({ type:"mcq", text:`C√¢u ${counter++}: Tr·∫Øc nghi·ªám`, options:["A","B","C","D"] });
    }
    for (let i=0;i<numTF;i++) {
      questions.push({ type:"truefalse", text:`C√¢u ${counter++}: ƒê√∫ng/Sai`, options:["√ù 1","√ù 2","√ù 3","√ù 4"] });
    }
    for (let i=0;i<numShort;i++) {
      questions.push({ type:"short", text:`C√¢u ${counter++}: Tr·∫£ l·ªùi ng·∫Øn` });
    }

    const examData = { pdfLink, questions };
    const examId = "exam" + Date.now();
    localStorage.setItem(examId, JSON.stringify(examData));

    const shareURL = window.location.origin + window.location.pathname + "?exam=" + examId;
    document.getElementById("shareLink").innerHTML =
      `üìå Link cho h·ªçc sinh: <a href="${shareURL}" target="_blank">${shareURL}</a>`;
  }

  // ========== STUDENT ==========
  const backBtn = document.getElementById("backBtn");
  const nextBtn = document.getElementById("nextBtn");

  function renderQuestion() {
    const q = questions[current];
    document.getElementById("question").innerText = q.text;
    const container = document.getElementById("options");
    container.innerHTML = "";

    if (q.type === "mcq") {
      q.options.forEach((opt) => {
        const div = document.createElement("div");
        div.className = "square";
        div.innerText = opt;
        if (answers[current] === opt) div.classList.add("selected");
        div.onclick = () => {
          container.querySelectorAll(".square").forEach(sq => sq.classList.remove("selected"));
          div.classList.add("selected");
          answers[current] = opt;
        };
        container.appendChild(div);
      });
    }
    else if (q.type === "truefalse") {
      q.options.forEach((opt) => {
        const group = document.createElement("div");
        group.style.display = "flex";
        group.style.alignItems = "center";
        group.style.gap = "4px";

        const label = document.createElement("span");
        label.innerText = opt+":";
        group.appendChild(label);

        ["ƒê","S"].forEach(choice => {
          const div = document.createElement("div");
          div.className = "square";
          div.innerText = choice;
          if (answers[current] && answers[current][opt] === choice) div.classList.add("selected");
          div.onclick = () => {
            group.querySelectorAll(".square").forEach(sq => sq.classList.remove("selected"));
            div.classList.add("selected");
            if (!answers[current]) answers[current] = {};
            answers[current][opt] = choice;
          };
          group.appendChild(div);
        });

        container.appendChild(group);
      });
    }
    else if (q.type === "short") {
      const wrapper = document.createElement("div");
      wrapper.className = "short-answer";
      for (let i=0;i<4;i++){
        const input = document.createElement("input");
        input.value = answers[current]?.[i] || "";
        input.oninput = () => {
          if (!answers[current]) answers[current] = [];
          answers[current][i] = input.value;
        };
        wrapper.appendChild(input);
      }
      container.appendChild(wrapper);
    }

    // update n√∫t
    backBtn.disabled = (current===0);
    nextBtn.innerText = (current===questions.length-1) ? "N·ªôp b√†i" : "Ti·∫øp ‚ñ∂";
  }

  function nextQuestion(){
    if (current < questions.length-1){
      current++;
      renderQuestion();
    } else {
      alert("Ho√†n th√†nh! ƒê√°p √°n: " + JSON.stringify(answers,null,2));
    }
  }

  function prevQuestion(){
    if (current>0){
      current--;
      renderQuestion();
    }
  }

  backBtn.onclick = prevQuestion;
  nextBtn.onclick = nextQuestion;

  // Khi m·ªü trang, ki·ªÉm tra c√≥ ?exam=... kh√¥ng
  const urlParams = new URLSearchParams(window.location.search);
  const examId = urlParams.get("exam");
  if (examId) {
    const examData = JSON.parse(localStorage.getItem(examId));
    if (examData) {
      // Ch·∫ø ƒë·ªô h·ªçc sinh
      document.getElementById("adminPanel").style.display="none";
      document.getElementById("examPanel").style.display="flex";
      questions = examData.questions;
      document.getElementById("pdfFrame").src = examData.pdfLink;
      current = 0;
      answers = {};
      renderQuestion();
    } else {
      document.body.innerHTML = "<h2>‚ùå ƒê·ªÅ thi kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a!</h2>";
    }
  }
</script>

</body>
</html>
